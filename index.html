<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metrónomo</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #121212;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  .app {
    text-align: center;
    width: 90%;
    max-width: 400px;
  }

  h1 {
    margin-bottom: 30px;
    font-size: 32px;
  }

  .bpm {
    font-size: 48px;
    margin: 20px 0;
  }

  .pulse {
    font-size: 32px;
    font-weight: bold;
    color: #1db954;
    margin: 20px 0;
  }

  input[type="range"] {
    width: 100%;
  }

  select {
    font-size: 16px;
    padding: 10px;
    margin-top: 20px;
    background: #333;
    color: #fff;
    border: none;
    border-radius: 5px;
  }

  button {
    margin-top: 30px;
    padding: 15px;
    width: 100%;
    font-size: 18px;
    border: none;
    border-radius: 10px;
    background: #1db954;
    color: #000;
    cursor: pointer;
  }

  button.stop {
    background: #ff5252;
    color: #000;
  }
</style>
</head>

<body>
<div class="app">
  <h1>Metrónomo</h1>
  <p style="text-shadow: 0.1em 0.1em 0.15em #e3e4e5">100% Libre de publicidad.</p>
  <div class="bpm" id="bpmValue">120 BPM</div>
  <input type="range" min="40" max="240" value="120" id="bpmSlider">

  <div class="pulse" id="pulseNumber">1</div>

  <select id="beatsPerMeasure">
    <option value="2">2 Pulsos</option>
    <option value="3">3 Pulsos</option>
    <option value="4" selected>4 Pulsos</option>
    <option value="5">5 Pulsos</option>
    <option value="6">6 Pulsos</option>
    <option value="7">7 Pulsos</option>
    <option value="8">8 Pulsos</option>
    <option value="9">9 Pulsos</option>
  </select>

  <button id="toggleBtn">▶ Iniciar</button>
</div>

<script>
/* =======================
   REGISTRO SERVICE WORKER
   ======================= */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

/* =======================
   WAKE LOCK (pantalla)
   ======================= */
let wakeLock = null;
async function lockScreen() {
  if ('wakeLock' in navigator) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
    } catch (e) {}
  }
}
function releaseScreen() {
  if (wakeLock) {
    wakeLock.release();
    wakeLock = null;
  }
}

/* =======================
   METRÓNOMO
   ======================= */
let audioCtx;
let isPlaying = false;
let tempo = 120;
let nextNoteTime = 0;
let timerID;
let currentPulse = 1;
let pulsesPerMeasure = 4;

const lookahead = 25;           // ms
const scheduleAheadTime = 0.1;  // s

function initAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playClick(time) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.frequency.value = 1000;
  gain.gain.value = 0.1;

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start(time);
  osc.stop(time + 0.05);
}

function scheduler() {
  while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
    playClick(nextNoteTime);
    nextNoteTime += 60 / tempo;
    updatePulseNumber();
  }
}

function start() {
  if (!audioCtx) initAudio();

  audioCtx.resume();
  nextNoteTime = audioCtx.currentTime + 0.05;
  timerID = setInterval(scheduler, lookahead);
  isPlaying = true;
  lockScreen();
}

function stop() {
  clearInterval(timerID);
  isPlaying = false;
  releaseScreen();
}

function updatePulseNumber() {
  currentPulse++;
  if (currentPulse > pulsesPerMeasure) {
    currentPulse = 1;
  }
  document.getElementById('pulseNumber').textContent = currentPulse;
}

/* =======================
   UI
   ======================= */
const slider = document.getElementById('bpmSlider');
const bpmValue = document.getElementById('bpmValue');
const btn = document.getElementById('toggleBtn');
const beatsSelect = document.getElementById('beatsPerMeasure');

slider.addEventListener('input', () => {
  tempo = slider.value;
  bpmValue.textContent = tempo + ' BPM';
});

beatsSelect.addEventListener('change', () => {
  pulsesPerMeasure = parseInt(beatsSelect.value, 10);
});

btn.addEventListener('click', () => {
  if (!isPlaying) {
    start();
    btn.textContent = '■ Detener';
    btn.classList.add('stop');
  } else {
    stop();
    btn.textContent = '▶ Iniciar';
    btn.classList.remove('stop');
  }
});
</script>
</body>
</html>
